import{w as a,f as te,u as q,a as oe,e as re,j as e,B as ae,a0 as ie,d as ne,g as le,s as M,a9 as ce,aa as de,ac as I,A as u,S as j,x as g,T as r,y as A,ad as me,L as ue,J as he}from"./index-PTjFC09f.js";import{C as R}from"./ConfigCard-Bm8nn3Gy.js";import{I as pe}from"./IconRefresh-BLXeIrsF.js";import{B as $}from"./Badge-B309Sa-B.js";import{D as fe}from"./Divider-j9_zKbmY.js";import{T as E}from"./TextInput-DMiFZDiy.js";import{P as we}from"./PasswordInput-BgN-ywAC.js";import{N as ge,C as H}from"./NumberInput-Yg5CGcNz.js";import{I as G}from"./IconUpload-BgF7fP5K.js";import{I as xe}from"./IconCheck-Xn7Y-yWz.js";import{I as V}from"./IconWifi-BlrcCQzB.js";import{P as je}from"./Progress-Bnkr7EzB.js";function ye({timeout:l=2e3}={}){const[h,o]=a.useState(null),[i,d]=a.useState(!1),[n,f]=a.useState(null),x=y=>{window.clearTimeout(n),f(window.setTimeout(()=>d(!1),l)),d(y)};return{copy:y=>{"clipboard"in navigator?navigator.clipboard.writeText(y).then(()=>x(!0)).catch(w=>o(w)):o(new Error("useClipboard: navigator.clipboard is not supported"))},reset:()=>{d(!1),o(null),window.clearTimeout(n)},error:h,copied:i}}var Q={root:"m_66836ed3",wrapper:"m_a5d60502",body:"m_667c2793",title:"m_6a03f287",label:"m_698f4f23",icon:"m_667f2a6a",message:"m_7fa78076",closeButton:"m_87f54839"};const ve={},be=ne((l,{radius:h,color:o,variant:i,autoContrast:d})=>{const n=l.variantColorResolver({color:o||l.primaryColor,theme:l,variant:i||"light",autoContrast:d});return{root:{"--alert-radius":h===void 0?void 0:le(h),"--alert-bg":o||i?n.background:void 0,"--alert-color":n.color,"--alert-bd":o||i?n.border:void 0}}}),O=te((l,h)=>{const o=q("Alert",ve,l),{classNames:i,className:d,style:n,styles:f,unstyled:x,vars:P,radius:T,color:y,title:w,children:z,id:F,icon:S,withCloseButton:c,onClose:B,closeButtonLabel:U,variant:v,autoContrast:b,...L}=o,m=oe({name:"Alert",classes:Q,props:o,className:d,style:n,classNames:i,styles:f,unstyled:x,vars:P,varsResolver:be}),k=re(F),p=w&&`${k}-title`||void 0,C=`${k}-body`;return e.jsx(ae,{id:k,...m("root",{variant:v}),variant:v,ref:h,...L,role:"alert","aria-describedby":C,"aria-labelledby":p,children:e.jsxs("div",{...m("wrapper"),children:[S&&e.jsx("div",{...m("icon"),children:S}),e.jsxs("div",{...m("body"),children:[w&&e.jsx("div",{...m("title"),"data-with-close-button":c||void 0,children:e.jsx("span",{id:p,...m("label"),children:w})}),z&&e.jsx("div",{id:C,...m("message"),"data-variant":v,children:z})]}),c&&e.jsx(ie,{...m("closeButton"),onClick:B,variant:"transparent",size:16,iconSize:16,"aria-label":U,unstyled:x})]})})});O.classes=Q;O.displayName="@mantine/core/Alert";const Ce={timeout:1e3};function X(l){const{children:h,timeout:o,value:i,...d}=q("CopyButton",Ce,l),n=ye({timeout:o}),f=()=>n.copy(i);return e.jsx(e.Fragment,{children:h({copy:f,copied:n.copied,...d})})}X.displayName="@mantine/core/CopyButton";/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ae=M("outline","alert-triangle","IconAlertTriangle",[["path",{d:"M12 9v4",key:"svg-0"}],["path",{d:"M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z",key:"svg-1"}],["path",{d:"M12 16h.01",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var K=M("outline","arrow-back","IconArrowBack",[["path",{d:"M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var J=M("outline","cloud-download","IconCloudDownload",[["path",{d:"M19 18a3.5 3.5 0 0 0 0 -7h-1a5 4.5 0 0 0 -11 -2a4.6 4.4 0 0 0 -2.1 8.4",key:"svg-0"}],["path",{d:"M12 13l0 9",key:"svg-1"}],["path",{d:"M9 19l3 3l3 -3",key:"svg-2"}]]);const Le=()=>{const l=ce(),h=de({uuid:"4880c12c-fdcb-4077-8920-a450d7f9b907"}),{characteristic:o}=h.useBluetoothCharacteristic({uuid:"fec26ec4-6d71-4442-9f81-55bc21d658d6"}),[i,d]=a.useState(null),[n,f]=a.useState(!1),[x,P]=a.useState("BT_GW_OTA"),[T,y]=a.useState("paramount123"),[w,z]=a.useState(300),[F,S]=a.useState(!1),[c,B]=a.useState(null),[U,v]=a.useState(!1),[b,L]=a.useState(""),[m,k]=a.useState(""),[p,C]=a.useState(null),[_,D]=a.useState(!1);a.useEffect(()=>{l.isConnected&&o&&N()},[l.isConnected,o]);const N=async()=>{if(o){f(!0);try{const t=await new I(o).sendCommand({cmd:"GET_VERSION",section:"system",data:{}});t.status==="success"&&t.data&&d(t.data)}catch(s){const t=s instanceof Error?s.message:"Unknown error";u.show({message:`Failed to load firmware info: ${t}`,color:"red"})}finally{f(!1)}}},Y=async()=>{if(o){if(T.length<8){u.show({message:"Password must be at least 8 characters",color:"red"});return}v(!0);try{const t=await new I(o).sendCommand({cmd:"START_OTA_AP",section:"system",data:{ssid:x,password:T,timeout_sec:w}});t.status==="success"&&t.data&&(S(!0),B({ssid:t.data.ssid,ip:t.data.ip,url:t.data.url}),u.show({message:"OTA Access Point started! Connect to the WiFi network.",color:"green"}))}catch(s){const t=s instanceof Error?s.message:"Unknown error";u.show({message:`Failed to start OTA AP: ${t}`,color:"red"})}finally{v(!1)}}},W=async()=>{if(o)try{await new I(o).sendCommand({cmd:"STOP_OTA",section:"system",data:{}}),S(!1),B(null),D(!1),C(null),u.show({message:"OTA cancelled",color:"blue"})}catch(s){const t=s instanceof Error?s.message:"Unknown error";u.show({message:`Failed to stop OTA: ${t}`,color:"red"})}},Z=async()=>{if(o){if(!b.startsWith("http://")&&!b.startsWith("https://")){u.show({message:"Please enter a valid HTTP/HTTPS URL",color:"red"});return}D(!0),C({state:0,progress:0,bytes_written:0,total_bytes:0,message:"Starting download..."});try{const t=await new I(o).sendCommand({cmd:"OTA_UPDATE",section:"system",data:{url:b,md5:m||void 0}},12e4);if(t.status==="error")throw new Error(t.message||"OTA failed");u.show({message:"Firmware download started. Device will reboot when complete.",color:"blue"})}catch(s){const t=s instanceof Error?s.message:"Unknown error";u.show({message:`OTA failed: ${t}`,color:"red"}),D(!1),C(null)}}},ee=async()=>{if(!(!o||!window.confirm("Are you sure you want to rollback to the previous firmware version? The device will reboot.")))try{await new I(o).sendCommand({cmd:"ROLLBACK",section:"system",data:{}}),u.show({message:"Rolling back to previous firmware...",color:"blue"})}catch(t){const se=t instanceof Error?t.message:"Unknown error";u.show({message:`Rollback failed: ${se}`,color:"red"})}};return e.jsxs(j,{gap:"md",children:[e.jsxs(g,{justify:"space-between",children:[e.jsx(r,{size:"xl",fw:700,children:"System & Firmware"}),e.jsx(A,{variant:"light",leftSection:e.jsx(pe,{size:16}),onClick:N,loading:n,children:"Refresh"})]}),e.jsx(R,{title:"Firmware Information",icon:e.jsx(me,{size:20}),children:i?e.jsxs(j,{gap:"sm",children:[e.jsxs(g,{children:[e.jsx(r,{fw:500,children:"Version:"}),e.jsx($,{size:"lg",variant:"filled",color:"blue",children:i.firmware_version})]}),e.jsxs(g,{children:[e.jsx(r,{fw:500,children:"Build Date:"}),e.jsx(r,{c:"dimmed",children:i.build_date})]}),e.jsx(fe,{my:"xs"}),e.jsxs(g,{children:[e.jsx(r,{fw:500,children:"Free Heap:"}),e.jsxs(r,{c:"dimmed",children:[(i.free_heap/1024).toFixed(1)," KB"]})]}),e.jsxs(g,{children:[e.jsx(r,{fw:500,children:"Flash Size:"}),e.jsxs(r,{c:"dimmed",children:[(i.flash_size/1024/1024).toFixed(1)," MB"]})]})]}):e.jsx(r,{c:"dimmed",children:"Click Refresh to load firmware information"})}),e.jsx(R,{title:"Local OTA Update (WiFi AP Mode)",icon:e.jsx(V,{size:20}),children:e.jsxs(j,{gap:"md",children:[e.jsx(O,{icon:e.jsx(Ae,{size:16}),color:"yellow",children:"This will temporarily disconnect the gateway from the network and create a WiFi hotspot for firmware upload. BLE connection may be lost during the update."}),F?e.jsxs(e.Fragment,{children:[e.jsx(O,{icon:e.jsx(V,{size:16}),color:"green",title:"OTA Access Point Active",children:e.jsxs(j,{gap:"xs",children:[e.jsxs(r,{size:"sm",children:[e.jsx("strong",{children:"1."})," Disconnect from this BLE connection"]}),e.jsxs(r,{size:"sm",children:[e.jsx("strong",{children:"2."})," Connect your device to WiFi network:"," ",e.jsx(H,{fw:700,children:c==null?void 0:c.ssid})]}),e.jsxs(r,{size:"sm",children:[e.jsx("strong",{children:"3."})," Open browser and go to:"]}),e.jsxs(g,{gap:"xs",wrap:"wrap",mt:"xs",children:[e.jsx(H,{fw:700,children:c==null?void 0:c.url}),e.jsx(X,{value:(c==null?void 0:c.url)||"",children:({copied:s,copy:t})=>e.jsx(ue,{label:s?"Copied!":"Copy URL",children:e.jsx(he,{size:"sm",variant:"subtle",onClick:t,color:s?"green":"gray",children:s?e.jsx(xe,{size:14}):e.jsx(G,{size:14})})})})]}),e.jsxs(r,{size:"sm",children:[e.jsx("strong",{children:"4."})," Upload the .bin firmware file"]})]})}),e.jsx(A,{color:"red",variant:"outline",onClick:W,children:"Cancel OTA Mode"})]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{label:"AP Network Name (SSID)",value:x,onChange:s=>P(s.currentTarget.value),placeholder:"BT_GW_OTA"}),e.jsx(we,{label:"AP Password",value:T,onChange:s=>y(s.currentTarget.value),description:"Minimum 8 characters"}),e.jsx(ge,{label:"Timeout (seconds)",value:w,onChange:s=>z(s),min:60,max:600,step:30,description:"AP will auto-disable after this time if no update occurs"}),e.jsx(A,{leftSection:e.jsx(G,{size:16}),onClick:Y,loading:U,children:"Start OTA Access Point"})]})]})}),e.jsx(R,{title:"Cloud OTA Update (URL Download)",icon:e.jsx(J,{size:20}),children:e.jsxs(j,{gap:"md",children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Download firmware directly from a URL."}),e.jsx(E,{label:"Firmware URL",placeholder:"https://bridgethings.com/user/repo/releases/download/v1.0/firmware.bin",value:b,onChange:s=>L(s.currentTarget.value),description:"URL to firmware binary file (.bin)"}),e.jsx(E,{label:"MD5 Hash (Optional)",placeholder:"e.g., d41d8cd98f00b204e9800998ecf8427e",value:m,onChange:s=>k(s.currentTarget.value),description:"32-character MD5 hash for integrity verification"}),p&&e.jsxs(j,{gap:"xs",children:[e.jsxs(g,{justify:"space-between",children:[e.jsx(r,{size:"sm",fw:500,children:p.message}),e.jsxs($,{children:[p.progress,"%"]})]}),e.jsx(je,{value:p.progress,animated:_,size:"lg"}),p.total_bytes>0&&e.jsxs(r,{size:"xs",c:"dimmed",ta:"center",children:[(p.bytes_written/1024).toFixed(0)," / ",(p.total_bytes/1024).toFixed(0)," KB"]})]}),e.jsxs(g,{children:[e.jsx(A,{leftSection:e.jsx(J,{size:16}),onClick:Z,loading:_,disabled:!b||_,children:"Download & Update"}),_&&e.jsx(A,{color:"red",variant:"outline",onClick:W,children:"Cancel"})]})]})}),e.jsx(R,{title:"Firmware Rollback",icon:e.jsx(K,{size:20}),children:e.jsxs(j,{gap:"sm",children:[e.jsx(r,{size:"sm",c:"dimmed",children:"If the current firmware has issues, you can rollback to the previous version."}),e.jsx(A,{color:"orange",variant:"outline",leftSection:e.jsx(K,{size:16}),onClick:ee,children:"Rollback to Previous Version"})]})})]})};export{Le as default};
